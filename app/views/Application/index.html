#{extends 'main.html' /} #{set title:'Team Reports' /} #{if isLogged}

<div id="header">
	<div class="logo">
		<img
			src="https://www.globallogic.com/wp-content/themes/globallogic/img/logo.png"
			width="106" height="18" alt="GlobalLogic logo" />
	</div>
	<div class="logininfo">
		<a class="blue" href="@{Security.logout}">${email} X</a>
	</div>
</div>

<div id="leftcolumn">
	<h1>TeamList</h1>

	<ul data-bind="foreach: teamList">
		<li
			data-bind="text: name, css: { selected: $root.chosenTeam() && name == $root.chosenTeam().name }, click: $root.chooseTeam">
		</li>
	</ul>
</div>

<div id="content">
	<h1>Options</h1>

	<form id="mainform" method="post" action="saveData">

		<p class="frm">
			<select class="selector"
				data-bind="options: $root.chosenTeam().storyList(), optionsText: 
			function(item)
			{
				return item.id + ' ' + item.desc;
			},
			value: $root.chosenTeam().story
			" /></select>
			<input id="opener" class="button" type="button"
				value="Find user story" />
		</p>
		<div>
			<table data-bind="foreach: reportEntries">
				<tr>
					<td data-bind="text: description"></td>
					<td><input
						data-bind="value: $root.chosenTeam().report[name], 
						css: { errorField: isNotValid($root.chosenTeam().report[name]())}"
						type="text" /></td>
				</tr>
			</table>
			<div data-bind="text: $root.summaryValid()" class="errMessage"></div>
		</div>


		<!--  div data-bind="text: $root.summaryValid()" class="errMessage"></div>-->

		<div class="buttons">
			<input data-bind="click: clearFields" class="button" type="button"
				value="Clear All" /> <input
				data-bind="click: saveReport, enable: isValid" class="button"
				type="button" value="Save" />
			<div id="reportLoader" style="float: right">
				<img
					src="/public/images/loader.gif" />
			</div>

		</div>
	</form>

	<div id="dialog-modal" title="Enter user story id">
		<label for="storyID">User story id</label> <input type="text"
			name="storyID" id="storyID"
			class="text ui-widget-content ui-corner-all" />

		<div id="loader">
			<img
				src="http://www.gargash.ae/wp-content/themes/gargash/images/spinner.gif" />
		</div>
		<p class="validateTips">All form fields are required.</p>
	</div>

	<!--********************************************************-->
	<script type="text/javascript" charset="${_response_encoding}">
		var isNotValid = function(value) {
			var isValid = true;
			if (value != "") {
				var reg = /^\d{0,2}(\.\d{0,2}){0,1}$/;
				isValid = isValid && reg.test(value) && parseFloat(value) >= 0
						&& parseFloat(value) <= 24;
			}
			return !isValid;
		}

		var createReportEntry = function(name, description) {
			return {
				name : name,
				description : description
			}
		}

		var reportEntries = [
				createReportEntry("storyTime", "Story Time"),
				createReportEntry("rework", "Rework"),
				createReportEntry("maintenance", "Maintenance"),
				createReportEntry("unplannedActivity", "Unplanned Activity"),
				createReportEntry("sickLeave", "Sick Leave"),
				createReportEntry("vacation", "Vacation"),
				createReportEntry("standUp", "Stand Up"),
				createReportEntry("retrospective", "Retrospective"),
				createReportEntry("projectPlanning", "Project Planning"),
				createReportEntry("demo", "Demo"),
				createReportEntry("estimates", "Estimates"),
				createReportEntry("projectMeetings", "Project Meetings"),
				createReportEntry("trainingAndDevelopment",
						"Training And Development"),
				createReportEntry("management", "Management") ];

		var createReportModel = function(entries) {
			var result = {};

			for ( var i in entries) {
				result[entries[i].name] = ko.observable("");
			}
			return result;

		}

		var createTeamModel = function(name) {
			return {
				name : name,
				storyList : ko.observable([]),
				story : ko.observable({}),
				report : createReportModel(reportEntries)
			};
		}

		var toKoTeamModel = function(teams) {
			var teamModels = [];
			for ( var index in teams) {
				teamModels.push(createTeamModel(teams[index]));
			}
			return teamModels;
		}

		var TeamListModel = function() {
			var self = this;

			self.teamList = ko.observable([]);
			self.chosenTeam = ko.observable(createTeamModel());
			self.isValid = ko.observable(false);

			self.summaryValid = ko
					.computed(function() {
						var rep = self.chosenTeam().report;
						var isValid = true;

						for (i in rep)
							isValid = isValid && !isNotValid(rep[i]());

						var sum = 0;
						var x = 0;
						var message = "";

						for (i in rep) {
							x = parseFloat(rep[i]());
							if (!isNaN(x))
								sum += x;
						}
						if (!isValid) {
							self.isValid(false);
							$(".errMessage").show();
							return "Not all fiels is valid!";
						}
						if (sum > 8 && sum <= 24) {
							self.isValid(true);
							$(".errMessage").show();
							message = "Are you really work " + sum + " hours.";
						} else if (sum > 24) {
							self.isValid(false);
							$(".errMessage").show();
							message = sum
									+ " hours spended. You cant work more than 24 hours.";
						} else if (sum < 8 && sum != 0) {
							self.isValid(true);
							$(".errMessage").show();
							message = sum + " hours spent. You need more work.";
						} else if (sum == 0) {
							self.isValid(false);
							$(".errMessage").hide();
						} else {
							self.isValid(true);
							$(".errMessage").hide();
						}

						if ((self.chosenTeam().story() != undefined) && (self.chosenTeam().report != undefined)){
							if (!/^((DE)|(US))([0-9])+$/i.test(self
									.chosenTeam().story().id) && self.chosenTeam().report["storyTime"]() != "") {
								self.isValid(false);
								$(".errMessage").show();
								message = "Choose userstory to save story time.";
							}
						}

						return message;

					});

			//get teamlist
			self.updateTeamList = function() {
				$.getJSON("@{DBManager.getTeamList()}", function(data) {
					self.teamList(toKoTeamModel(data));

					if (self.teamList() && self.teamList().length) {
						self.chosenTeam(self.teamList()[0]);
					}
					self.updateUSList();
				});
			}

			//get teamlist
			self.updateUSList = function(id) {
				//console.log(self.chosenTeam().story());
				$.getJSON(
						"@{DBManager.getUserStories()}?team="
								+ self.chosenTeam().name,
						function(data) {
							if (self.chosenTeam().story()) {
								self.chosenTeam().storyList(data);

								for (var i = 0; i < self.chosenTeam()
										.storyList().length; i++) {
									if (self.chosenTeam().storyList()[i].id == id) {
										self
											.chosenTeam()
											.story(
													self
														.chosenTeam()
														.storyList()[i]);
										break;
									}
								}
							} else {
								self.chosenTeam().storyList(data);
							}
						});
			}

			function showReportLoader(isLoading) {
				if (isLoading){
					self.isValid(false);
					$('#reportLoader').show();
				}
				else{
					self.isValid(true);
					$('#reportLoader').hide();
				}
			}

			//send report to server
			self.saveReport = function() {
				var link = "@{GoogleService.report}";

				var finalReport = {};
				
				finalReport.mail = "${email}";
				finalReport.team = self.chosenTeam().name;
				finalReport.usId = self.chosenTeam().story().id;
				finalReport.usName = self.chosenTeam().story().desc;
				
				for(i in self.chosenTeam().report){
					if(self.chosenTeam().report.hasOwnProperty(i))
						finalReport[i] = self.chosenTeam().report[i]();
				}
				
				//console.log(finalReport);
				
				$.ajax({
					url : link,
					type : "POST",
					data : finalReport,
					context : document.body,
					beforeSend : function() {
						showReportLoader(true);
					}
				}).done(function(data) {
					showReportLoader(false);
				});
			}

			self.clearFields = function() {
				var rep = self.chosenTeam().report;

				for ( var param in rep) {
					if (rep.hasOwnProperty(param)) {
						rep[param]("");
					}
				}
			}

			//set new team and refresh US list
			self.chooseTeam = function(teamModel) {
				//kostyl'
				var id = teamModel.story().id;
				self.chosenTeam(teamModel);
				self.updateUSList(id);
			}

			//JS dialog to find user story from rally
			$(function() {
				var storyID = $("#storyID"), allFields = $([]).add(storyID), tips = $(".validateTips");
				var findedTask;

				function updateTips(t) {
					tips.text(t).addClass("ui-state-highlight");
					setTimeout(function() {
						tips.removeClass("ui-state-highlight", 1500);
					}, 500);
				}

				function checkLength(o, n, min, max) {
					if (o.val().length > max || o.val().length < min) {
						o.addClass("ui-state-error");
						updateTips("Length of " + n + " must be between " + min
								+ " and " + max + ".");
						return false;
					} else {
						return true;
					}
				}

				function checkRegexp(o, regexp, n) {
					if (!(regexp.test(o.val()))) {
						o.addClass("ui-state-error");
						updateTips(n);
						return false;
					} else {
						return true;
					}
				}

				function updateOk(isDisabled) {
					if (isDisabled) {
						$(".ui-dialog-buttonpane button:contains('Ok')").attr(
								"disabled", true).addClass("ui-state-disabled");
					} else {
						$(".ui-dialog-buttonpane button:contains('Ok')").attr(
								"disabled", false).removeClass(
								"ui-state-disabled");
					}
				}

				function showLoading(isLoading) {
					if (isLoading) {
						$('#loader').show();
						$('.validateTips').hide();
					} else {
						$('#loader').hide();
						$('.validateTips').show();
					}
				}
				$("#dialog-modal")
						.dialog({
									autoOpen : false,
									height : 250,
									width : 400,
									resizable : false,
									modal : true,
									buttons : {
										"Ok" : function() {
											var link = "@{DBManager.updateUserStory}?id="
													+ findedTask.FormattedID
													+ "&desc="
													+ findedTask.Name
													+ "&team="
													+ self.chosenTeam().name;

											$.ajax({ url : link,
													context : document.body,
													beforeSend : function() {
														showLoading(true);
													}
											}).done(function(data) {
												showLoading(false);
												self.updateUSList();
												$("#dialog-modal")
													.dialog("close");
											});
										},
										"Find" : function() {
											var isValid = true;
											allFields
													.removeClass("ui-state-error");
											isValid = isValid
													&& checkLength(storyID,
															"userstory id", 3,
															15);
											isValid = isValid
													&& checkRegexp(
															storyID,
															/^((DE)|(US))([0-9])+$/i,
															"Userstory id must begin from US or DE and ends with id number.");
											if (isValid) {
												var link = "@{RallyService.example}?id="
														+ storyID.val();

												$
														.ajax(
																{
																	url : link,
																	context : document.body,
																	beforeSend : function() {
																		showLoading(true);
																	}
																})
														.done(
																function(data) {
																	showLoading(false);

																	updateTips(data.Name);
																	findedTask = data;
																	if (data.FormattedID != "Error") {
																		updateOk(false);
																	} else {
																		storyID
																				.addClass("ui-state-error");
																		updateOk(true);
																	}
																});
											}
										},
										"Cancel" : function() {
											$(this).dialog("close");
										}
									},
									close : function() {
										findedTask = null;
										updateOk(true);
										updateTips("");
										showLoading(false);
										allFields.val("").removeClass(
												"ui-state-error");
									}
								});
				updateOk(true);

				$("#opener").click(function() {
					$("#dialog-modal").dialog("open");
				});
				
				self.updateTeamList();
				$('#loader').hide();
				$('#reportLoader').hide();
			});
		};

		var model = new TeamListModel()
		ko.applyBindings(model);
	</script>
	<!--********************************************************-->

	<div id="footer">
		<div class="logo">
			<img
				src="https://www.globallogic.com/wp-content/themes/globallogic/img/logo.png"
				width="106" height="18" alt="GlobalLogic logo" />
		</div>
		<div class="info">2013 year.</div>
	</div>
</div>
#{/if} #{else}

<div id="header">
	<div class="logo">
		<img
			src="https://www.globallogic.com/wp-content/themes/globallogic/img/logo.png"
			width="106" height="18" alt="GlobalLogic logo" />
	</div>
</div>

<div id="leftcolumn">
	<h1>Please Login</h1>
</div>

<div id="content">
	<h1>Please login</h1>

	<div class="login">
		<table>
			<tr>
				<td><img
					src="https://ssl.gstatic.com/ui/v1/icons/mail/logo_white.png" /></td>
				<td><a class="blue" href="@{Security.tryAuthGoogle}">Login
						with google</a></td>
			</tr>
		</table>
	</div>

	<div id="footer">
		<div class="logo">
			<img
				src="https://www.globallogic.com/wp-content/themes/globallogic/img/logo.png"
				width="106" height="18" alt="GlobalLogic logo" />
		</div>
		<div class="info">2013 year.</div>
	</div>
</div>
#{/else}
